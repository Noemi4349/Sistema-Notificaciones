<div class="p-grid p-0">
  <!-- üïí SECCI√ìN DE PROGRAMACI√ìN AUTOM√ÅTICA - Mejorada -->
  <div class="p-col-12">
    <div class="programar-envio-mejorado p-card shadow-1 p-3 border-round bg-surface-100">
      <h3 class="titulo-envio-compacto">üïí PROGRAMAR ENVIO</h3>
      <div class="hora-container-mejorado">
        <div class="selector-hora-compacto">
          <label for="horaEnvio" class="etiqueta-hora-small">Hora:</label>
          <input
            id="horaEnvio"
            type="time"
            [(ngModel)]="horaProgramada"
            class="p-inputtext p-component input-hora-small"
          />
          <p-button
            label="Guardar"
            (onClick)="guardarHoraProgramada()"
            styleClass="p-button-warning p-button-sm btn-guardar-small">
          </p-button>
        </div>
        <!-- Mensaje de confirmaci√≥n y contador EN 2 L√çNEAS -->
        <div *ngIf="horaGuardada" class="info-programacion">
          <p class="text-green-600 font-semibold mensaje-guardado-small">
            ‚úÖ Env√≠o programado para {{ horaGuardada }}
          </p>
          <p *ngIf="tiempoRestante" class="contador-regresivo">
            ‚è±Ô∏è Faltan: 
            <strong *ngIf="tiempoRestante.dias > 0">{{ tiempoRestante.dias }}d </strong>
            <strong>{{ tiempoRestante.horas }}h </strong>
            <strong>{{ tiempoRestante.minutos }}m </strong>
            <strong>{{ tiempoRestante.segundos }}s</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úâÔ∏è PANEL PRINCIPAL DE ENV√çO -->
  <div class="p-col-12">
    <div class="p-card p-5 bg-surface-50 border-round shadow-1 mt-3">

      <!-- Encabezado y botones alineados a la derecha -->
      <div class="encabezado-felicitaciones-mejorado">
        <h2 class="text-900 font-bold titulo-felicitaciones">üéâ Env√≠o de felicitaciones</h2>

        <div class="botones-derecha">
          <p-button
            label="Subir archivo"
            icon="pi pi-upload"
            styleClass="p-button-info p-button-sm"
            (onClick)="abrirSubirDialog()">
          </p-button>

          <p-button
            label="Insertar mensaje"
            icon="pi pi-pencil"
            styleClass="p-button-success p-button-sm"
            (onClick)="mostrarCampoMensaje = !mostrarCampoMensaje">
          </p-button>

          <p-button
            label="Ver reporte"
            icon="pi pi-chart-bar"
            styleClass="p-button-warning p-button-sm"
            (onClick)="verReporte = !verReporte">
          </p-button>
        </div>
      </div>

      <!-- üìù Campo de mensaje personalizado CON BOT√ìN GUARDAR -->
      <div *ngIf="mostrarCampoMensaje" class="mb-4 mt-3">
        <label class="font-semibold mb-2 block">Mensaje personalizado:</label>
        <textarea
          [(ngModel)]="mensajePersonalizado"
          rows="4"
          placeholder="Escribe aqu√≠ tu mensaje de felicitaci√≥n..."
          class="p-inputtext p-component w-full mb-2">
        </textarea>
        
        <!-- üëá Botones para guardar o cancelar -->
        <div class="flex justify-content-end gap-2">
          <p-button
            label="Cancelar"
            icon="pi pi-times"
            styleClass="p-button-text p-button-sm"
            (onClick)="mostrarCampoMensaje = false">
          </p-button>
          <p-button
            label="Guardar mensaje"
            icon="pi pi-save"
            styleClass="p-button-success p-button-sm"
            (onClick)="guardarMensajePersonalizado()"
            [loading]="loading">
          </p-button>
        </div>
      </div>

      <!-- üëÅÔ∏è Vista previa centrada tipo m√≥vil -->
      <div class="vista-previa-movil" *ngIf="mensajePersonalizado || archivoSeleccionado">
        <h4 class="text-center text-900 font-semibold mb-3">Vista previa del mensaje üéà</h4>
        <div class="contenedor-movil">
          <!-- Primero el archivo multimedia -->
          <div *ngIf="archivoSeleccionado" class="media-preview-movil">
            <img *ngIf="archivoSeleccionado.type.startsWith('image/')" [src]="mediaURL" alt="Vista previa de imagen" />
            <video *ngIf="archivoSeleccionado.type.startsWith('video/')" [src]="mediaURL" controls></video>
          </div>
          <!-- Luego el mensaje -->
          <div class="mensaje-preview-movil">
            <p>{{ mensajePersonalizado }}</p>
          </div>
        </div>
      </div>

      <!-- üìã Tabla de socios - Ancho completo -->
      <div class="tabla-socios-full mt-4">
        <p-table
          [value]="socios"
          [paginator]="true"
          [rows]="5"
          [loading]="loading"
          responsiveLayout="scroll"
          class="shadow-2 border-round">
          <ng-template pTemplate="header">
            <tr>
              <th>Nombre completo</th>
              <th>Tel√©fono</th>
              <th>Fecha de nacimiento</th>
              <th>Acciones</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-socio>
            <tr>
              <td>{{ socio.nombreCompleto }}</td>
              <td>{{ socio.telefono }}</td>
              <td>{{ socio.fechaNacimiento | date:'dd/MM/yyyy' }}</td>
              <td>
                <p-button
                  label="Enviar Ahora"
                  icon="pi pi-send"
                  styleClass="p-button-sm p-button-rounded p-button-primary"
                  (onClick)="abrirEnviarDialog(socio)">
                </p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <!-- üìä Reporte mejorado - Debajo de la tabla -->
      <!-- üëá CAMBIOS AQU√ç -->
      <div *ngIf="verReporte" class="reporte-completo mt-4">
        <div class="header-reporte">
          <h3 class="text-900 font-bold">üìú Reporte de env√≠os a socios</h3>
          <p-button
            label="Imprimir"
            icon="pi pi-print"
            styleClass="p-button-warning p-button-sm"
            (onClick)="imprimirReporte()">
          </p-button>
        </div>
        
        <p-table 
          [value]="reporteEnvios" 
          [rows]="10" 
          [paginator]="true" 
          responsiveLayout="scroll" 
          class="mt-3"
          [loading]="loading">
          <ng-template pTemplate="header">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Tel√©fono</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Estado</th>
              <th>Tipo mensaje</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-registro>
            <tr>
              <td>{{ registro.id || 'N/A' }}</td>
              <td>{{ registro.nombre }}</td>
              <td>{{ registro.telefono }}</td>
              <td>{{ registro.fecha | date:'dd/MM/yyyy' }}</td>
              <td>{{ registro.hora || (registro.fecha | date:'HH:mm') }}</td>
              <td>
                <span [ngClass]="{
                  'text-green-600 font-bold': registro.estado === 'ENVIADO',
                  'text-red-600 font-bold': registro.estado === 'FALLIDO',
                  'text-orange-600 font-bold': registro.estado === 'PENDIENTE'
                }">
                  {{ registro.estado }}
                </span>
              </td>
              <td>{{ registro.tipoMensaje || 'Texto' }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="text-center p-4">
                <i class="pi pi-inbox text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">No hay env√≠os registrados a√∫n</p>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
      <!-- üëÜ FIN DE CAMBIOS -->
    </div>
  </div>
</div>

<!-- üìÅ Di√°logo para subir archivo -->
<p-dialog
  header="Subir archivo multimedia"
  [(visible)]="displaySubirDialog"
  [modal]="true"
  [style]="{ width: '400px' }"
  [closable]="true">
  <p-fileUpload
    name="file"
    mode="basic"
    (onSelect)="onFileSelect($event)"
    chooseLabel="Seleccionar archivo"
    accept="image/*,video/*"
    auto="false">
  </p-fileUpload>
  
  <!-- Mostrar archivo seleccionado -->
  <div *ngIf="archivoSeleccionado" class="mt-3 p-2 bg-blue-50 border-round">
    <p class="m-0 text-sm">
      <i class="pi pi-file mr-2"></i>
      <strong>{{ archivoSeleccionado.name }}</strong>
      <br>
      <span class="text-xs text-gray-600">
        Tama√±o: {{ (archivoSeleccionado.size / 1024).toFixed(2) }} KB
      </span>
    </p>
  </div>
  
  <div class="flex justify-content-end gap-2 mt-3">
    <p-button 
      label="Cancelar" 
      icon="pi pi-times" 
      (onClick)="cancelarSubida()" 
      styleClass="p-button-text">
    </p-button>
    <p-button 
      label="Subir" 
      icon="pi pi-upload" 
      (onClick)="subirMedia()" 
      styleClass="p-button-success"
      [loading]="loading"
      [disabled]="!archivoSeleccionado">
    </p-button>
  </div>
</p-dialog>